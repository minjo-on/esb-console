<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="eai_monitor">

	<typeAlias alias="monitor" type="com.indigo.web.agent.vo.EaiMonitorVO" />
	<typeAlias alias="monitorResource" type="com.indigo.web.agent.vo.EaiMonitorResourceVO" />

	<sql id="product_table">esb_PRODUCT</sql>
	<sql id="monitor_table">esb_MONITOR</sql>
	<sql id="monitor_resource_table">esb_MONITOR_RESOURCE</sql>

	<sql id="monitor_cols">
		MO_ID, IM_STATUS, NW_STATUS, DS_STATUS, CPU_USE,
		MEMORY_USE,
		CPU_TIME, ELAPSED_TIME, MO_REG_DATE, MO_STATUS, PD_ID
	</sql>
	
	<sql id="monitor_resource_cols">
		MO_ID, MO_TYPE, PD_ID, CPU_USE, DISK_USE, JVM_USE, MO_REG_DATE
	</sql>

	<sql id="join_cols">
		MO.MO_ID, MO.IM_STATUS, MO.NW_STATUS, MO.DS_STATUS,
		MO.CPU_USE, MO.MEMORY_USE,
		MO.CPU_TIME, MO.ELAPSED_TIME,
		MO.MO_REG_DATE, MO.MO_STATUS, MO.PD_ID,
		PD.PD_TYPE, PD.PD_ORDER,
		PD.PD_NAME, PD.PD_ALIAS, PD.PD_REG_DATE,
		PD.PD_REG_USER,
		PD.IN_IM_ID,
		PD.FINAL_NW_STATUS, PD.FINAL_MO_STATUS, PD.FINAL_MO_REG_DATE,
		PD.MO_ERROR_CNT
	</sql>

	<select id="getMonitorListByColumn" resultClass="monitor"
		parameterClass="map">
		SELECT <include refid="join_cols" />
		FROM <include refid="product_table" /> PD, <include refid="monitor_table" /> MO
		WHERE PD.PD_ID = MO.PD_ID
		<isNotNull property="PD_ID" prepend="and">
           PD_ID = #PD_ID#
        </isNotNull>
        <isNotNull property="PD_NAME" prepend="and">
           PD_NAME = #PD_NAME#
        </isNotNull>
		<isNotEmpty property="SRCH_TEXT" prepend="AND">
			PD_NAME LIKE '%'||#SRCH_TEXT#||'%' AND
			PD_ALIAS LIKE '%'||#SRCH_TEXT#||'%'
		</isNotEmpty>
		order by MO_REG_DATE DESC
	</select>
	
	 <!-- <select id="getProductListByColumn" resultClass="product" parameterClass="map">
        SELECT
		    PD_ID, PD_TYPE, PD_ORDER, PD_NAME, PD_ALIAS, PD_REG_DATE, PD_REG_USER,
		    IN_IM_ID, FINAL_NW_STATUS, FINAL_MO_STATUS, FINAL_DS_STATUS, FINAL_MO_REG_DATE, MO_ERROR_CNT,PD_GROUP_ID,
		    PD_FAVORITE, PD_FIREWALL,
      		(SELECT COUNT(*) FROM   <include refid="monitor_table" /> EM WHERE  EM.PD_ID = EP.PD_ID) MO_CNT
		FROM  <include refid="product_table"/> EP
		WHERE
		      $COL$ = #COL_VALUE#
	</select> -->

	<select id="getMonitorCount" resultClass="Integer" parameterClass="string">
		SELECT COUNT(*) FROM <include refid="monitor_table" />
		WHERE PD_ID = #VALUE:VARCHAR:NO_ENTRY#
	</select>

	<select id="getMonitorMinId" resultClass="String" parameterClass="string"> 
		SELECT MIN(MO_ID) FROM <include refid="monitor_table" /> WHERE PD_ID = #VALUE# 
	</select>
	
	<select id="getMonitorResource" resultClass="monitorResource" parameterClass="HashMap">
		SELECT * FROM <include refid="monitor_resource_table" />
		WHERE MO_REG_DATE = (SELECT MAX(MO_REG_DATE)
		FROM <include refid="monitor_resource_table" />
		WHERE MO_TYPE=#mo_type#
		AND PD_ID=#pd_id#
		)AND MO_TYPE=#mo_type#
		AND PD_ID=#pd_id#
	</select>

	<select id="getMonitorResourceList" resultClass="monitorResource" parameterClass="HashMap">
		SELECT * FROM (
		SELECT * FROM <include refid="monitor_resource_table" />
		WHERE MO_TYPE=#mo_type#
		AND PD_ID=#pd_id#
		ORDER BY MO_REG_DATE DESC
		)
		  <![CDATA[ WHERE ROW_NUMBER() OVER AS ROWNUM <= 6  ]]>
		ORDER BY MO_REG_DATE
	</select>

	<select id="pingQuery">
		SELECT CURRENT_TIMESTAMP FROM SYSIBM.SYSDUMMY1
	</select>

	<!-- rownum add query (To quicken full scan. 2010-01-14) -->
	<!-- <select id="getMonitorMinId" resultClass="String"
		parameterClass="string">
		select min(MO_ID)
		from
		<include refid="monitor_table" />
		where PD_ID = #value:VARCHAR:NO_ENTRY#
	</select> -->

	<insert id="insertMonitor" parameterClass="monitor">
		INSERT INTO <include refid="monitor_table" />
		( <include refid="monitor_cols" /> ) VALUES (#mo_id#, #im_status#, #nw_status#, #ds_status#, #cpu_use#,
		#memory_use#, #cpu_time#, #elapsed_time#, #mo_reg_date#, #mo_status#, #pd_id#)
	</insert>
	
	<update id="updateMonitor" parameterClass="monitor">
		UPDATE <include refid="monitor_table" /> SET MO_ID = #mo_id#,
			IM_STATUS = #im_status#, NW_STATUS = #nw_status#, DS_STATUS = #ds_status#, CPU_USE = #cpu_use#,
			MEMORY_USE = #memory_use#, CPU_TIME = #cpu_time#, ELAPSED_TIME = #elapsed_time#,
			MO_REG_DATE = #mo_reg_date#, MO_STATUS = #mo_status#, PD_ID = #pd_id#
		WHERE
			MO_ID = (SELECT MIN(MO_ID) from esb_MONITOR WHERE PD_ID = #pd_id#)
	</update>

	<delete id="deleteMonitor" parameterClass="string">
		DELETE FROM <include refid="monitor_table" />
		WHERE MO_ID = #VALUE:VARCHAR:NO_ENTRY#
	</delete>

	<!-- delete records by ProductID patch -->
	<delete id="deleteMonitorByPD_ID" parameterClass="string">
		DELETE FROM <include refid="monitor_table" />
		WHERE PD_ID = #VALUE:VARCHAR:NO_ENTRY#
	</delete>

    <select id="getMonitorImStatusCount" resultClass="Integer" parameterClass="map">
    	SELECT COUNT(*) FROM
		(
		SELECT distinct PD_STATUS, Z.*
		FROM
			(SELECT PD_ID, PD_NAME, PD_ALIAS,
			CASE WHEN SIGN({fn TIMESTAMPDIFF(SQL_TSI_DAY, CURRENT_TIMESTAMP, FINAL_MO_REG_DATE)} * 24 * 60 * 60 * 1000 - (3 * 60 * 1000)) != -1 THEN 'ERROR'
			WHEN SIGN({fn TIMESTAMPDIFF(SQL_TSI_DAY, CURRENT_TIMESTAMP, FINAL_MO_REG_DATE)} * 24 * 60 * 60 * 1000 - (3 * 60 * 1000)) IS NULL THEN 'ERROR'
			WHEN {fn TIMESTAMPDIFF(SQL_TSI_SECOND, FINAL_MO_REG_DATE, current_timestamp)}  > 180 THEN 'ERROR'
			ELSE 'SUCCESS'
			END AS PD_STATUS
			FROM ESB_PRODUCT A
			<dynamic>
					 <isNotNull property="USER_ID">
					 	, INDIGO_GROUP_MAPPING UMG
					 </isNotNull>
			</dynamic>
			WHERE A.PD_TYPE=#PD_TYPE#
			<dynamic>
      				<isNotNull property="USER_ID" prepend="and">
          				A.PD_GROUP_ID = UMG.GROUP_ID
		        		AND UMG.USER_ID = #USER_ID#
		        	</isNotNull>
		        	<isNotNull property="GROUP_ID" prepend="and">
					<iterate prepend="A.PD_GROUP_ID IN" property="GROUP_ID" open="(" conjunction="," close=")">
							 #GROUP_ID[]#
					</iterate>
				</isNotNull>
				<!-- <isNotEmpty property="GROUP_ID">
					PD_GROUP_ID = #GROUP_ID#
				</isNotEmpty> -->
			</dynamic>) Z
			WHERE PD_STATUS = #STATUS#) ZZ
    </select>
    
     <select id="getMonitorAdStatusCount" resultClass="Integer" parameterClass="map">
     select count(*) from
	(
		SELECT PD_ID, PD_NAME, PD_ALIAS, 
			CASE 
				WHEN STATUS IN ('1','0') THEN 'SUCCESS'
				WHEN STATUS IN ('-2') THEN 'STOP'
				WHEN STATUS = 'NULL' THEN 'ERROR'
				ELSE 'ERROR' 
			END AS AD_STATUS
		FROM (
			SELECT PD_ID, PD_NAME, PD_ALIAS,
				CASE
					WHEN { FN TIMESTAMPDIFF( SQL_TSI_MINUTE, FINAL_MO_REG_DATE, CURRENT_TIMESTAMP ) } >= 3 THEN '-9'
					ELSE CASE
							WHEN FINAL_MO_STATUS = '-2' THEN '-2' 
							WHEN FINAL_MO_STATUS = '-1' THEN '-1'
						ELSE CASE
							WHEN FINAL_NW_STATUS = '99' THEN '2'
								ELSE CASE WHEN FINAL_MO_STATUS IS NULL THEN 'NULL' ELSE FINAL_MO_STATUS END
							END
						END
				END
				AS STATUS
			FROM ESB_PRODUCT A
			<dynamic>
					 <isNotNull property="USER_ID">
					 	, INDIGO_GROUP_MAPPING UMG
					 </isNotNull>
			</dynamic>
			WHERE A.PD_TYPE=#PD_TYPE#
			<dynamic>
      				<isNotNull property="USER_ID" prepend="and">
          				A.PD_GROUP_ID = UMG.GROUP_ID
		        		AND UMG.USER_ID = #USER_ID#
		        	</isNotNull>
		        	<isNotNull property="GROUP_ID" prepend="and">
					<iterate prepend="A.PD_GROUP_ID IN" property="GROUP_ID" open="(" conjunction="," close=")">
							 #GROUP_ID[]#
					</iterate>
				</isNotNull>
			</dynamic>
			<!-- WHERE PD_TYPE=#PD_TYPE#
			<dynamic prepend="and">
				<isNotEmpty property="GROUP_ID">
					PD_GROUP_ID = #GROUP_ID#
				</isNotEmpty>
			</dynamic> -->) T ) Z
			WHERE Z.AD_STATUS=#STATUS#
    </select>
    
	<!-- delete records by ProductID patch -->
	<insert id="insertMonitorResource" parameterClass="monitorResource">
		INSERT INTO <include refid="monitor_resource_table" />
		( <include refid="monitor_resource_cols" /> ) VALUES
		(#mo_id#, #mo_type#, #pd_id#, #cpu_use#, #disk_use#, #jvm_use#, CURRENT_TIMESTAMP)
	</insert>
</sqlMap>