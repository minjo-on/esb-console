<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="eai_instance">

	<typeAlias alias="instance"        type="com.indigo.web.agent.vo.EaiInstanceVO"/>
	<typeAlias alias="instance_file"   type="com.indigo.web.agent.vo.EaiInstanceFileVO"/>
	<typeAlias alias="history_file"   type="com.indigo.web.agent.vo.EaiInstanceFileVO"/>
	
	<resultMap id="instance_file_map" class="instance_file">
	    <result property="in_id"         column="IN_ID"         jdbcType="VARCHAR" />
	    <result property="in_file_id"    column="IN_FILE_ID"    jdbcType="VARCHAR" />
	    <result property="in_file_name"  column="IN_FILE_NAME"  jdbcType="VARCHAR" />
	    <result property="in_file_conts" column="IN_FILE_CONTS" jdbcType="CLOB" typeHandler="declob" />
	    <result property="history_file_size" column="HISTORY_FILE_SIZE" jdbcType="VARCHAR" />
	    <result property="history_date"  column="HISTORY_DATE" jdbcType="VARCHAR" />
	</resultMap>
	
	<resultMap id="instance_History_map" class="history_file">
		<result property="history_id" 	 column="HISTORY_ID" jdbcType="VARCHAR" />
	 	<result property="history_date"  column="HISTORY_DATE" jdbcType="VARCHAR" />
	    <result property="in_file_conts" column="HISTORY_FILE_CONTS" jdbcType="CLOB" typeHandler="declob" />
	</resultMap>
	
	<!-- <parameterMap class="instance_file" id="derby_insert_history_map">
		<parameter property="in_id"          javaType="string"       jdbcType="VARCHAR" />
		<parameter property="in_file_id"     javaType="int"   jdbcType="VARCHAR" />
		<parameter property="in_file_conts"	javaType="[B"  jdbcType="CLOB" typeHandler="declob" />
		<parameter property="history_file_size" javaType="string"  jdbcType="VARCHAR" />
		<parameter property="history_memo" javaType="string"  jdbcType="VARCHAR" />
	    <parameter property="history_date"  javaType="string"  jdbcType="VARCHAR" />
	</parameterMap> -->
	
	<parameterMap class="instance_file" id="derby_instance_file_map">
	 	<parameter property="in_id"       	javaType="string"   jdbcType="VARCHAR" />
	    <parameter property="in_file_id"   	javaType="int"  jdbcType="VARCHAR" />
	    <parameter property="in_file_conts"	javaType="[B"  jdbcType="CLOB" typeHandler="declob" />
	</parameterMap>
	
	<resultMap id="history_file_map" class="history_file">
		<result property="in_id"         column="IN_ID"         jdbcType="VARCHAR" />
	    <result property="in_file_id"    column="IN_FILE_ID"    jdbcType="VARCHAR" />
	    <result property="in_file_name"  column="IN_FILE_NAME"  jdbcType="VARCHAR" />
	    <result property="in_file_conts" column="HISTORY_FILE_CONTS" jdbcType="CLOB" typeHandler="declob" />
	    <result property="history_version"      column="HISTORY_VERSION"         jdbcType="VARCHAR" />
	    <result property="history_file_size" 	column="HISTORY_FILE_SIZE" jdbcType="VARCHAR" />
	    <result property="history_memo" 	column="HISTORY_MEMO" jdbcType="VARCHAR" />
	    <result property="history_id" 			column="HISTORY_ID" jdbcType="VARCHAR" />
	    <result property="history_date"  		column="HISTORY_DATE" jdbcType="VARCHAR" />
	    <result property="use_data_yn"  		column="USE_DATAYN" jdbcType="VARCHAR" />
	</resultMap>

	<sql id="product_table">esb_PRODUCT</sql>
	<sql id="instance_table">esb_INSTANCE</sql>
	<sql id="instance_file_table">esb_INSTANCE_FILE</sql>
	<sql id="project_table">esb_PROJECT</sql>
	<sql id="group_mapping">INDIGO_GROUP_MAPPING</sql>
	<sql id="indigo_cmm_resource_history_table">INDIGO_CMM_RESOURCE_HISTORY</sql>
	<sql id="instance_cols">
	    IN_ID, PJ_ID, IN_INFO, IN_DEPLOY_YN, IN_DEPLOY_DATE, IN_START_XMS, IN_START_XMX, IN_COMPILER_OPT, IN_AUTOSTART_YN, IN_AUTOSTART_CNT, IN_EXCLUSIVE_CLASSPATH, IN_PORT
	</sql>

	<sql id="join_cols">
	    PD.PD_ID, PD.PD_TYPE, PD.PD_ORDER, PD.PD_NAME, PD.PD_ALIAS, PD.PD_REG_DATE, PD.PD_REG_USER,
	    PD.IN_IM_ID,
	   (SELECT PD_NAME  FROM esb_PRODUCT WHERE PD_ID = PD.IN_IM_ID) AS IN_IM_NAME,
       (SELECT PD_ALIAS FROM esb_PRODUCT WHERE PD_ID = PD.IN_IM_ID) AS IN_IM_ALIAS,
	    PD.FINAL_NW_STATUS, PD.FINAL_MO_STATUS, PD.FINAL_DS_STATUS, PD.FINAL_MO_REG_DATE, PD.MO_ERROR_CNT,
	    INS.IN_ID, INS.PJ_ID, INS.IN_INFO, INS.IN_DEPLOY_YN, INS.IN_DEPLOY_DATE,
        INS.IN_START_XMS, INS.IN_START_XMX, INS.IN_COMPILER_OPT, INS.IN_AUTOSTART_YN, INS.IN_AUTOSTART_CNT, INS.IN_PORT,
        PJ.PJ_NAME, INS.IN_EXCLUSIVE_CLASSPATH,  PD.PD_FAVORITE
	</sql>

	<!-- <cacheModel type="MEMORY" id="TreeCasheMEM">
		<flushOnExecute statement="esb_instance.deleteInstance"/>
		<flushOnExecute statement="esb_instance.insertInstance"/>
		<flushOnExecute statement="esb_product.updateProductByInstance"/>
		<flushInterval minutes="30"/>
	</cacheModel> -->
	
     <select id="getEaiInstanceListByColumn" resultClass="instance" parameterClass="map">
       select t2.*
			from(
			select ROW_NUMBER() OVER () AS row_num, t1.*
			from(
				select <include refid="join_cols" />
			        from   <include refid="product_table" /> PD, <include refid="instance_table" /> INS, <include refid="project_table" /> PJ
			        where  PD.PD_ID = INS.IN_ID
			        and    INS.PJ_ID = PJ.PJ_ID
			        <isNotNull property="PD_ALIAS" prepend="and">
			            PD_ALIAS = #PD_ALIAS#
			        </isNotNull>
			        <isNotNull property="IN_ID" prepend="and">
			            IN_ID = #IN_ID#
			        </isNotNull>
			        <isNotNull property="PD_NAME" prepend="and">
			            PD_NAME = #PD_NAME#
			        </isNotNull>
			        <isNotNull property="PJ_ID" prepend="and">
			            PJ.PJ_ID = #PJ_ID#
			        </isNotNull>
			        <isNotNull property="IN_IM_ID" prepend="and">
			            PD.IN_IM_ID = #IN_IM_ID#
			        </isNotNull>
			        <isNotNull prepend="PD_GROUP_ID" property="and">
			        	PD.PD_GROUP_ID = #PD_GROUP_ID#
			        </isNotNull>
			        order by PD.PD_ORDER, PD.PD_ALIAS
			       )t1
				)t2
				 <isNotNull prepend="SKIP_INDEX" property="and">
			        <![CDATA[
           OFFSET #SKIP_INDEX# ROWS FETCH first #MAX_ROW# ROW ONLY
	]]>
				</isNotNull>
    </select>

 	<select id="getEaiInstanceListByColumnCount" resultClass="int" parameterClass="map">
		select count(PD.PD_ID)
		    from   <include refid="product_table" /> PD, <include refid="instance_table" /> INS, <include refid="project_table" /> PJ
		    where  PD.PD_ID = INS.IN_ID
			    and    INS.PJ_ID = PJ.PJ_ID
			    <isNotNull property="PD_ALIAS" prepend="and">
			        PD_ALIAS = #PD_ALIAS#
			    </isNotNull>
			    <isNotNull property="IN_ID" prepend="and">
			        IN_ID = #IN_ID#
			    </isNotNull>
			    <isNotNull property="PD_NAME" prepend="and">
			        PD_NAME = #PD_NAME#
			    </isNotNull>
			    <isNotNull property="PJ_ID" prepend="and">
			        PJ.PJ_ID = #PJ_ID#
			    </isNotNull>
			    <isNotNull property="IN_IM_ID" prepend="and">
			        PD.IN_IM_ID = #IN_IM_ID#
			    </isNotNull>
			    <isNotNull prepend="PD_GROUP_ID" property="and">
			        PD.PD_GROUP_ID = #PD_GROUP_ID#
			    </isNotNull>
<!-- 		    order by PD.PD_ORDER, PD.PD_ALIAS -->
    </select>
    
    <select id="getEaiInstanceByColumnLike" resultClass="instance" parameterClass="map">
        SELECT <include refid="join_cols" />
        FROM   <include refid="product_table" /> PD, <include refid="instance_table" /> INS, <include refid="project_table" /> PJ
        WHERE  PD.PD_ID = INS.IN_ID
        AND    INS.PJ_ID = PJ.PJ_ID
        ORDER BY PD.PD_ORDER, PD.PD_ALIAS
    </select>

	<select id="getEaiInstanceListAD" resultClass="instance" parameterClass="map">
		SELECT PD_NAME, PD_ALIAS FROM <include refid="product_table" />
		<dynamic prepend="WHERE">
		<isNotNull property="PD_ID">
        IN_IM_ID = #PD_ID#
        </isNotNull>
		</dynamic>
	</select>

    <select id="getEaiInstancePortListAD" resultClass="instance" parameterClass="map">
        SELECT PD2.PD_NAME, PD2.PD_ALIAS, INS.IN_PORT
        FROM   <include refid="product_table" /> PD, <include refid="product_table" /> PD2, <include refid="instance_table" /> INS
        WHERE  PD.PD_ID = PD2.IN_IM_ID
        AND    PD2.PD_ID = INS.IN_ID
        <isNotNull property="PD_ID" prepend="and">
        	PD.PD_ID = #PD_ID#
        </isNotNull>
        ORDER BY INS.IN_PORT ASC
    </select>

	<select id="getEaiInstanceCountByPjId" resultClass="Integer" parameterClass="string">
	    SELECT count(*)
	    FROM   <include refid="instance_table" />
	    WHERE  PJ_ID = #VALUE:VARCHAR:NO_ENTRY#
	</select>

	<select id="getEaiInstanceCountByInName" resultClass="Integer" parameterClass="map">
	    SELECT count(*)
	    FROM   <include refid="product_table" />
	    WHERE  PD_TYPE = 'AD'
	    AND    PD_NAME = #IN_NAME:VARCHAR:NO_ENTRY#
	    <isNotNull property="IN_ID" prepend="AND">
            PD_ID   <![CDATA[ <> ]]> #IN_ID:VARCHAR:NO_ENTRY#
	    </isNotNull>
	</select>

	<select id="getEaiInstanceAdFileList" resultClass="instance_file" parameterClass="string">
		SELECT F.IN_ID, F.IN_FILE_ID, F.IN_FILE_NAME, H.HISTORY_FILE_CONTS AS IN_FILE_CONTS, H.HISTORY_DATE, H.HISTORY_FILE_SIZE
		FROM <include refid="instance_file_table" /> F, <include refid="indigo_cmm_resource_history_table" /> H
		WHERE F.HISTORY_ID = H.HISTORY_ID AND H.USE_DATAYN = 'Y'
		AND F.IN_ID = #VALUE:VARCHAR:NO_ENTRY#
	</select>

	<select id="getEaiInstanceConfigList" resultMap="instance_file_map" parameterClass="map">
		SELECT F.IN_ID, F.IN_FILE_ID, F.IN_FILE_NAME, H.HISTORY_FILE_CONTS AS IN_FILE_CONTS, H.HISTORY_DATE, H.HISTORY_FILE_SIZE
		FROM <include refid="instance_file_table" /> F, <include refid="indigo_cmm_resource_history_table" /> H
		WHERE F.HISTORY_ID = H.HISTORY_ID AND H.USE_DATAYN = 'Y' AND F.IN_ID = #IN_ID:VARCHAR:NO_ENTRY#
		<isNotNull property="IN_FILE_ID" prepend="AND">
			F.IN_FILE_ID = #IN_FILE_ID:NUMERIC:-999999#
		</isNotNull>
	</select>

	<select id="getEaiInstanceConfigListByImID" resultMap="instance_file_map" parameterClass="string">
		SELECT A.IN_ID, A.IN_FILE_ID, A.IN_FILE_NAME, H.HISTORY_FILE_CONTS AS IN_FILE_CONTS, H.HISTORY_DATE, H.HISTORY_FILE_SIZE
		FROM <include refid="instance_file_table" /> A, <include refid="product_table" /> B, <include refid="indigo_cmm_resource_history_table" /> H
		WHERE A.IN_ID = B.PD_ID AND A.HISTORY_ID = H.HISTORY_ID AND H.USE_DATAYN = 'Y'
		AND B.IN_IM_ID = #VALUE:VARCHAR:NO_ENTRY#
	</select>

	<select id="getEaiInstanceConfigMainList" resultClass="instance_file" parameterClass="string">
		SELECT F.IN_ID, F.IN_FILE_ID, F.IN_FILE_NAME, H.HISTORY_DATE , H.HISTORY_FILE_SIZE
		FROM <include refid="instance_file_table" /> F, <include refid="indigo_cmm_resource_history_table" /> H
		WHERE F.HISTORY_ID = H.HISTORY_ID AND H.USE_DATAYN = 'Y'
		AND F.IN_ID = #VALUE:VARCHAR:NO_ENTRY# 
		AND F.IN_FILE_ID IN (1, 2)
	</select>

	<select id="getEaiInstanceConfigOtherList" resultClass="instance_file" parameterClass="string">
		SELECT F.IN_ID, IN_FILE_ID, F.IN_FILE_NAME, H.HISTORY_DATE , H.HISTORY_FILE_SIZE
		FROM <include refid="instance_file_table" /> F, <include refid="indigo_cmm_resource_history_table" /> H
		WHERE F.HISTORY_ID = H.HISTORY_ID AND H.USE_DATAYN = 'Y'
		AND F.IN_ID = #VALUE:VARCHAR:NO_ENTRY#
		AND F.IN_FILE_ID NOT IN (1, 2)
	</select>

	<select id="getNextEaiInstanceConfigFileId" resultClass="Integer" parameterClass="string">
		SELECT MAX(IN_FILE_ID) + 1
		FROM <include refid="instance_file_table" />
		WHERE IN_ID = #VALUE:VARCHAR:NO_ENTRY#
	</select>

	<select id="getEaiInstanceConfigFileId" resultClass="Integer" parameterClass="java.util.Map">
		SELECT IN_FILE_ID
		FROM <include refid="instance_file_table" />
		WHERE IN_ID = #IN_ID#
		AND IN_FILE_NAME = #IN_FILE_NAME#
	</select>

	<select id="getFavoriteEaiInstanceList" resultClass="instance" parameterClass="java.util.Map">
		SELECT <include refid="join_cols" />
        FROM   <include refid="product_table" /> PD, <include refid="instance_table" /> INS, <include refid="project_table" /> PJ
        	   <isNotNull property="USER_ID">
				,<include refid="group_mapping" /> UMG
			   </isNotNull>
        WHERE  PD.PD_ID = INS.IN_ID
        AND    INS.PJ_ID = PJ.PJ_ID
        <isNotNull property="USER_ID" prepend="AND">
        	PD.PD_GROUP_ID = UMG.GROUP_ID
        	AND UMG.USER_ID = #USER_ID#
        </isNotNull>
        <isNotNull property="GROUP_ID" prepend="AND">
        	PD.PD_GROUP_ID = #GROUP_ID#
        </isNotNull>
        <isNotNull property="FAVORITE" prepend="AND">
        	PD.PD_FAVORITE = #FAVORITE#
        </isNotNull>
        ORDER BY PD.PD_ORDER, PD.PD_NAME
	</select>
	
	<select id="getPageEaiInstance" resultClass="instance" parameterClass="java.util.Map">
		SELECT T2.*
			FROM(
				SELECT ROW_NUMBER() OVER() AS ROW_NUM, T1.*
			    FROM(
						SELECT <include refid="join_cols" />, PD.PD_STATUS
				        FROM <include refid="instance_table" /> INS, <include refid="project_table" /> PJ,
				        	(SELECT CASE WHEN {FN TIMESTAMPDIFF(SQL_TSI_SECOND, FINAL_MO_REG_DATE, CURRENT_TIMESTAMP)}  > 180 THEN '-9'
						ELSE CASE WHEN FINAL_MO_STATUS = '-2' THEN '-2'
								WHEN FINAL_MO_STATUS = '-1' THEN '-1'
								ELSE CASE WHEN FINAL_NW_STATUS = '99' THEN '2'
								ELSE CASE WHEN FINAL_MO_STATUS IS NOT NULL THEN FINAL_MO_STATUS
								ELSE 'NULL' END
									END
								END
						 END PD_STATUS, PD1.*
                  			 FROM <include refid="product_table" /> PD1) PD
				        WHERE  PD.PD_ID = INS.IN_ID
				        AND    INS.PJ_ID = PJ.PJ_ID
				        ORDER BY PD.PD_ORDER, PD.PD_NAME
				) T1
                <dynamic prepend="WHERE">
                	<isNotNull property="PJ_ID" prepend="AND">
				    T1.PJ_ID = #PJ_ID#
				    </isNotNull>
				    <isNotNull property="IN_IM_ALIAS" prepend="and">
				    IN_IM_ALIAS LIKE '%' ||#IN_IM_ALIAS#|| '%'
				    </isNotNull>
				    <isNotNull property="PD_ALIAS" prepend="and">
				    PD_ALIAS LIKE '%' ||#PD_ALIAS#|| '%'
				    </isNotNull>
				    <isNotNull property="pd_name" prepend="and">
				    PD_NAME LIKE '%' ||#pd_name#|| '%'
				    </isNotNull>
				    <isNotNull property="pj_name" prepend="and">
				    PJ_NAME LIKE '%' ||#pj_name#|| '%'
				    </isNotNull>
				    <isNotNull property="im_name" prepend="and">
				    IM_NAME LIKE '%' ||#im_name#|| '%'
				    </isNotNull>
				    <isNotNull property="pj_name" prepend="and">
				    PJ_NAME LIKE '%' ||#pj_name#|| '%'
				    </isNotNull>
				    <isNotNull property="pj_reg_user" prepend="and">
				    PJ_REG_USER LIKE '%' ||#pj_reg_user#|| '%'
				    </isNotNull>
				    <isNotNull property="STATUS_VALUE" prepend="AND">
				    T1.PD_STATUS = #STATUS_VALUE#
				    </isNotNull>
				</dynamic>
			) T2
		<![CDATA[
			WHERE  row_num > #SKIP_INDEX#
			AND  row_num <= #MAX_ROW#
		]]>
	</select>
	
	<select id="getTotEaiInstance"  resultClass="integer" parameterClass="java.util.Map">
				SELECT COUNT(*)
			    FROM(
						SELECT <include refid="join_cols" />, PD.PD_STATUS
				        FROM <include refid="instance_table" /> INS, <include refid="project_table" /> PJ,
				        	(SELECT CASE WHEN {FN TIMESTAMPDIFF(SQL_TSI_SECOND, FINAL_MO_REG_DATE, CURRENT_TIMESTAMP)}  > 180 THEN '-9'
						ELSE CASE WHEN FINAL_MO_STATUS = '-2' THEN '-2'
								WHEN FINAL_MO_STATUS = '-1' THEN '-1'
								ELSE CASE WHEN FINAL_NW_STATUS = '99' THEN '2'
								ELSE CASE WHEN FINAL_MO_STATUS IS NOT NULL THEN FINAL_MO_STATUS
								ELSE 'NULL' END
									END
								END
						 END PD_STATUS, PD1.*
                  			 FROM <include refid="product_table" /> PD1) PD
				        WHERE  PD.PD_ID = INS.IN_ID
				        AND    INS.PJ_ID = PJ.PJ_ID
				) T1
                <dynamic prepend="WHERE">
                	<isNotNull property="PJ_ID" prepend="AND">
				    T1.PJ_ID = #PJ_ID#
				    </isNotNull>
				    <isNotNull property="IN_IM_ALIAS" prepend="and">
				    IN_IM_ALIAS LIKE '%' ||#IN_IM_ALIAS#|| '%'
				    </isNotNull>
				    <isNotNull property="PD_ALIAS" prepend="and">
				    PD_ALIAS LIKE '%' ||#PD_ALIAS#|| '%'
				    </isNotNull>
				    <isNotNull property="pd_name" prepend="and">
				    PD_NAME LIKE '%' ||#pd_name#|| '%'
				    </isNotNull>
				    <isNotNull property="pj_name" prepend="and">
				    PJ_NAME LIKE '%' ||#pj_name#|| '%'
				    </isNotNull>
				    <isNotNull property="im_name" prepend="and">
				    IM_NAME LIKE '%' ||#im_name#|| '%'
				    </isNotNull>
				    <isNotNull property="pj_name" prepend="and">
				    PJ_NAME LIKE '%' ||#pj_name#|| '%'
				    </isNotNull>
				    <isNotNull property="pj_reg_user" prepend="and">
				    PJ_REG_USER LIKE '%' ||#pj_reg_user#|| '%'
				    </isNotNull>
				    <isNotNull property="STATUS_VALUE" prepend="AND">
				    T1.PD_STATUS = #STATUS_VALUE#
				    </isNotNull>
				</dynamic>
	</select>

    <insert id="insertInstance" parameterClass="instance">
        INSERT INTO <include refid="instance_table" />
            (<include refid="instance_cols" />)
        VALUES
            (#in_id:VARCHAR:NO_ENTRY#, #pj_id:VARCHAR:NO_ENTRY#, #in_info:VARCHAR:NO_ENTRY#, #in_deploy_yn:VARCHAR:NO_ENTRY#, #in_deploy_date:TIMESTAMP#,
             #in_start_xms:VARCHAR:NO_ENTRY#, #in_start_xmx:VARCHAR:NO_ENTRY#, #in_compiler_opt:VARCHAR:NO_ENTRY#, #in_autostart_yn:VARCHAR:NO_ENTRY#,
             #in_autostart_cnt:NUMERIC:-999999#, #in_exclusive_classpath:VARCHAR:NO_ENTRY#, #in_port:VARCHAR:NO_ENTRY#)
    </insert>

    <insert id="insertInstanceFile" parameterClass="instance_file">
		INSERT INTO
		<include refid="instance_file_table" />
		(IN_ID, IN_FILE_ID, IN_FILE_NAME, HISTORY_ID)
		values
		(#in_id:VARCHAR:NO_ENTRY#, #in_file_id:NUMERIC:-999999#, #in_file_name:VARCHAR:NO_ENTRY#,
		CAST (#in_id:VARCHAR:NO_ENTRY#||'_'||#in_file_id:VARCHAR# AS VARCHAR(255)))
	</insert>
	
    <update id="updateInstance" parameterClass="instance">
        UPDATE  <include refid="instance_table" />
        SET     IN_INFO          = #in_info:VARCHAR:NO_ENTRY# ,
				IN_START_XMS     = #in_start_xms:VARCHAR:NO_ENTRY# ,
				IN_START_XMX     = #in_start_xmx:VARCHAR:NO_ENTRY# ,
				IN_PORT          = #in_port:VARCHAR:NO_ENTRY# ,
				IN_COMPILER_OPT  = #in_compiler_opt:VARCHAR:NO_ENTRY# ,
				IN_AUTOSTART_YN  = #in_autostart_yn:VARCHAR:NO_ENTRY# ,
				IN_AUTOSTART_CNT = #in_autostart_cnt:NUMERIC:-999999#,
				IN_EXCLUSIVE_CLASSPATH = #in_exclusive_classpath:VARCHAR:NO_ENTRY#
        WHERE   IN_ID = #in_id:VARCHAR:NO_ENTRY#
    </update>

    <update id="updateInstanceFile" parameterClass="instance_file">
        UPDATE <include refid="instance_file_table" />
        SET    IN_FILE_CONTS = #in_file_conts,handler=declob#
        WHERE  IN_ID      = #in_id:VARCHAR:NO_ENTRY#
        AND    IN_FILE_ID = #in_file_id:VARCHAR#
    </update>
    
	<!-- INDIGO_CMM_RESOURCE_HISTORY ibatis start -->
	<select id="getCountEaiinstanceConfigHistory" resultClass="integer" parameterClass="instance_file">
		SELECT COUNT(HISTORY_ID) FROM <include refid="indigo_cmm_resource_history_table" />
		WHERE HISTORY_ID = CAST (#in_id:VARCHAR:NO_ENTRY#||'_'||#in_file_id:VARCHAR# AS VARCHAR(255))
	</select>

	<delete id="deleteEaiinstanceConfigHistory" parameterClass="instance_file">
    	DELETE FROM <include refid="indigo_cmm_resource_history_table" />
		WHERE HISTORY_ID = CAST (#in_id:VARCHAR:NO_ENTRY#||'_'||#in_file_id:VARCHAR# AS VARCHAR(255)) 
			AND USE_DATAYN ='N' AND HISTORY_DATE = (SELECT MIN(HISTORY_DATE) FROM <include refid="indigo_cmm_resource_history_table" />
													WHERE HISTORY_ID = CAST (#in_id:VARCHAR:NO_ENTRY#||'_'||#in_file_id:VARCHAR# AS VARCHAR(255)) 
														AND USE_DATAYN ='N')
	</delete>

	<update id="updateEaiinstanceConfigHistory" parameterClass="instance_file">
    	UPDATE <include refid="indigo_cmm_resource_history_table" /> SET USE_DATAYN ='N'
			WHERE HISTORY_ID = CAST (#in_id:VARCHAR:NO_ENTRY#||'_'||#in_file_id:VARCHAR# AS VARCHAR(255))
	</update>
	
	<insert id="insertEaiinstanceConfigHistory" parameterClass="instance_file" >
		INSERT INTO <include refid="indigo_cmm_resource_history_table" />(HISTORY_ID, HISTORY_FILE_CONTS, HISTORY_FILE_SIZE, USE_DATAYN, HISTORY_VERSION, HISTORY_MEMO, HISTORY_DATE) 
			VALUES(#in_id:VARCHAR:NO_ENTRY# || '_' || #in_file_id:VARCHAR#, #in_file_conts,handler=declob#, #history_file_size:VARCHAR:NO_ENTRY#, 'Y',
				  (SELECT CASE WHEN MAX(HISTORY_VERSION) IS NULL THEN 0
				   ELSE MAX(HISTORY_VERSION)+1 END HISTORY_VERSION
				   FROM <include refid="indigo_cmm_resource_history_table" /> WHERE HISTORY_ID = CAST (#in_id:VARCHAR:NO_ENTRY#||'_'||#in_file_id:VARCHAR# AS VARCHAR(255)))
				  ,#history_memo:VARCHAR#, #history_date#
			)
	</insert>
	
	<delete id="deleteInstanceHistoryFile" parameterClass="map">
		DELETE FROM <include refid="indigo_cmm_resource_history_table" />
		WHERE HISTORY_ID = CAST (#IN_ID:VARCHAR:NO_ENTRY#||'_'||#IN_FILE_ID:VARCHAR# AS VARCHAR(255))
	</delete>
	
	<delete id="deleteInstanceHistoryFiles" parameterClass="string">
		DELETE FROM <include refid="indigo_cmm_resource_history_table" />
		WHERE HISTORY_ID LIKE #value:VARCHAR:NO_ENTRY# || '%'
	</delete>
	
	<select id="selectConfigHistory" resultMap="history_file_map"  parameterClass="map">
		SELECT F.IN_ID, F.IN_FILE_ID, F.IN_FILE_NAME, H.HISTORY_ID, H.USE_DATAYN, H.HISTORY_FILE_SIZE, H.HISTORY_FILE_CONTS,H.HISTORY_DATE, H.HISTORY_VERSION, H.HISTORY_MEMO
	    FROM <include refid="indigo_cmm_resource_history_table" /> H, <include refid="instance_file_table" /> F 
		WHERE H.HISTORY_ID = F.HISTORY_ID
    		AND H.HISTORY_ID =  CAST (#in_id:VARCHAR:NO_ENTRY#||'_'||#in_file_id:VARCHAR# AS VARCHAR(255)) ORDER BY HISTORY_DATE DESC
	</select>
	
	<select id="selectConfigHistoryXml" resultMap="instance_History_map"  parameterClass="map">
		SELECT HISTORY_ID, HISTORY_DATE, HISTORY_FILE_CONTS FROM <include refid="indigo_cmm_resource_history_table" />
		WHERE HISTORY_ID = #HISTORY_ID:VARCHAR:NO_ENTRY# AND HISTORY_DATE = #HISTORY_DATE:VARCHAR:NO_ENTRY# 
	</select>
	
	<update id="configFileHistoryUpdate" parameterClass="map">
    	UPDATE <include refid="indigo_cmm_resource_history_table" /> SET USE_DATAYN ='Y'
			WHERE HISTORY_ID = #HISTORY_ID:VARCHAR:NO_ENTRY# AND HISTORY_DATE = #HISTORY_DATE:VARCHAR:NO_ENTRY# 
	</update>
	<!-- INDIGO_CMM_RESOURCE_HISTORY ibatis end -->
	
    <delete id="deleteInstance" parameterClass="string">
        DELETE FROM <include refid="instance_table" />
        WHERE  IN_ID = #VALUE:VARCHAR:NO_ENTRY#
    </delete>

    <delete id="deleteInstanceFile" parameterClass="map">
        DELETE FROM <include refid="instance_file_table" />
        WHERE  IN_ID = #IN_ID:VARCHAR:NO_ENTRY#
	    AND    IN_FILE_ID = #IN_FILE_ID:NUMERIC:-999999#
    </delete>

    <delete id="deleteInstanceFiles" parameterClass="String">
        DELETE FROM <include refid="instance_file_table" />
        WHERE  IN_ID = #VALUE:VARCHAR:NO_ENTRY#
    </delete>

    <update id="updateDeployOperation" parameterClass="map">
        UPDATE <include refid="instance_table" />
        SET    IN_DEPLOY_YN   = #IN_DEPLOY_YN:VARCHAR:NO_ENTRY# ,
               IN_DEPLOY_DATE = #IN_DEPLOY_DATE:TIMESTAMP#
        WHERE  IN_ID = #IN_ID:VARCHAR:NO_ENTRY#
    </update>

	<!-- // Adapter Copy/Move (inserted by kangnaru 2012-02-20) -->
    <insert id="copyInstance" parameterClass="instance">
        INSERT INTO <include refid="instance_table" />
            (<include refid="instance_cols" />)
        (SELECT
        	#in_id:VARCHAR:NO_ENTRY#, #pj_id:VARCHAR:NO_ENTRY#, IN_INFO, 'N' AS IN_DEPLOY_YN, IN_DEPLOY_DATE, IN_START_XMS,
			IN_START_XMX, IN_COMPILER_OPT, IN_AUTOSTART_YN, IN_AUTOSTART_CNT, IN_EXCLUSIVE_CLASSPATH, #in_port:VARCHAR:NO_ENTRY#
		 FROM <include refid="instance_table" />
			WHERE IN_ID = #old_in_id:VARCHAR:NO_ENTRY#)
    </insert>

    <insert id="copyInstanceFile" parameterClass="instance_file">
        INSERT INTO ESB_INSTANCE_FILE(IN_ID, IN_FILE_ID, IN_FILE_NAME, HISTORY_ID)
        (SELECT
        	#in_id:VARCHAR:NO_ENTRY#,  F.IN_FILE_ID, F.IN_FILE_NAME, #in_id:VARCHAR:NO_ENTRY#||'_'|| CAST(F.IN_FILE_ID AS CHAR(2))
		 FROM  ESB_INSTANCE_FILE F, INDIGO_CMM_RESOURCE_HISTORY H
			WHERE F.HISTORY_ID = H.HISTORY_ID AND  F.IN_ID = #old_in_id:VARCHAR:NO_ENTRY# AND H.USE_DATAYN = 'Y')
    </insert>
    
    <insert id="copyhistoryFile" parameterClass="instance_file">
        INSERT INTO <include refid="indigo_cmm_resource_history_table" />(HISTORY_ID,HISTORY_FILE_CONTS,HISTORY_FILE_SIZE,HISTORY_DATE,USE_DATAYN,HISTORY_VERSION,HISTORY_MEMO)
        (SELECT
        	#in_id:VARCHAR:NO_ENTRY# || '_' ||  cast( F.IN_FILE_ID AS CHAR(20)), CAST(H.HISTORY_FILE_CONTS AS CLOB), H.HISTORY_FILE_SIZE, #history_date#, 'Y', 0, HISTORY_MEMO 
		 FROM  <include refid="instance_file_table" /> F, <include refid="indigo_cmm_resource_history_table" /> H
			WHERE F.HISTORY_ID = H.HISTORY_ID AND  F.IN_ID = #old_in_id:VARCHAR:NO_ENTRY# AND H.USE_DATAYN = 'Y')
    </insert>
    
    <update id="updateChangeAdForPropertyName" parameterClass="map">
	UPDATE <include refid="instance_file_table" />
	SET IN_FILE_NAME = #NEW_FILE_NAME:VARCHAR:NO_ENTRY#
	WHERE IN_ID = #IN_ID:VARCHAR:NO_ENTRY#
	AND IN_FILE_NAME = #IN_FILE_NAME:VARCHAR:NO_ENTRY#
    </update>
    
    <update id="moveInstance" parameterClass="instance">
        UPDATE <include refid="instance_table" />
        SET
        	PJ_ID = #pj_id:VARCHAR:NO_ENTRY#
		WHERE IN_ID = #old_in_id:VARCHAR:NO_ENTRY#
    </update>

    <update id="updateInstanceProjectId" parameterClass="map">
        UPDATE <include refid="instance_table" />
        SET
        	PJ_ID = #PROJECT_ID:VARCHAR:NO_ENTRY#
		WHERE IN_ID = #INSTANCE_ID:VARCHAR:NO_ENTRY#
    </update>

    <update id="updateInstanceFavorite" parameterClass="map">
        UPDATE <include refid="product_table" />
        SET    PD_FAVORITE  = #FAVORITE#
        WHERE  PD_ID = #INSTANCE_ID:VARCHAR:NO_ENTRY#
    </update>
    
    <!-- 공통리소스 -->
	<select id="getCommonResourceFile" resultClass="Integer" parameterClass="map">
		SELECT count(IN_ID)
	    FROM   <include refid="instance_file_table" />
	    WHERE IN_ID = #IN_ID:VARCHAR:NO_ENTRY# 
	      AND IN_FILE_NAME = #IN_FILE_NAME:VARCHAR:NO_ENTRY#
	</select>
	
	<select id="getEaiInstanceConfigForFileNameList" resultMap="instance_file_map" parameterClass="map">
	    SELECT F.IN_ID, F.IN_FILE_ID, F.IN_FILE_NAME, H.HISTORY_FILE_CONTS AS IN_FILE_CONTS, H.HISTORY_DATE, H.HISTORY_FILE_SIZE
	    FROM   <include refid="instance_file_table" /> F, <include refid="indigo_cmm_resource_history_table" /> H
	    WHERE  F.HISTORY_ID = H.HISTORY_ID AND H.USE_DATAYN = 'Y'
	    AND  F.IN_ID = #IN_ID:VARCHAR:NO_ENTRY#
	    AND  F.IN_FILE_NAME = #IN_FILE_NAME:VARCHAR:NO_ENTRY#
	</select>
	
	<select id= "getPdId" parameterClass="string" resultClass = "string">
		select PD_ID from esb_product where PD_NAME = #pd_name#
	</select>
	
	<update id="updateAdaptorInstance" parameterClass="map">
		update <include refid="instance_table" />
		SET  IN_START_XMS = #in_start_xms#,
			 IN_START_XMX = #in_start_xmx#,
			 IN_AUTOSTART_YN = #in_autostart_yn#,
			 IN_AUTOSTART_CNT = #in_autostart_cnt#,
			 IN_PORT = #in_port#
		WHERE IN_ID = #pd_id#
	</update>
	
	<update id="updateAdaptorProduct" parameterClass="map">
		update <include refid="product_table"/>
		SET  FINAL_MO_REG_DATE = #updateTime#
		WHERE PD_ID = #pd_id#	 
	</update>
	
	<select id = "getExistenceAdaptor" parameterClass="map" resultClass = "string">
		SELECT PD_ALIAS
		FROM <include refid="product_table" />
		WHERE PD_ID = #PD_NAME# AND IN_IM_ID = #PD_ID#
	</select>
	
	<select id="getProjectNameByInid" parameterClass="map" resultClass="string">
		SELECT PJ_NAME 
		FROM <include refid="project_table" /> 
		WHERE PJ_ID = (SELECT PJ_ID FROM <include refid="instance_table" /> WHERE IN_ID=#in_id#)
	</select>
</sqlMap>