<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="file_meta">

    <typeAlias alias="fileMeta" type="com.indigo.web.filetransfer.vo.FileMetaVO"/>

    <sql id="file_meta_table">FILE_META</sql>

    <sql id="file_meta_cols">
        INTERFACE_ID, TABLE_NAME, DELIMITER, COLUMNS, ENCODING, HAS_HEADER, FILE_EXTENSION, CREATED_AT, UPDATED_AT
    </sql>

    <resultMap id="fileMetaResult" class="fileMeta">
        <result property="interfaceId" column="INTERFACE_ID"/>
        <result property="tableName" column="TABLE_NAME"/>
        <result property="delimiter" column="DELIMITER"/>
        <result property="columns" column="COLUMNS" jdbcType="VARCHAR" typeHandler="myclob"/>
        <result property="encoding" column="ENCODING"/>
        <result property="hasHeader" column="HAS_HEADER"/>
        <result property="fileExtension" column="FILE_EXTENSION"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="updatedAt" column="UPDATED_AT"/>
    </resultMap>

    <select id="selectFileMetaList" parameterClass="java.lang.String" resultMap="fileMetaResult">
        select <include refid="file_meta_cols" />
        from   <include refid="file_meta_table" />
        <dynamic prepend="where">
            <isNotEmpty property="value" prepend="and">
                (
                    INTERFACE_ID LIKE '%' || #value# || '%' OR
                    TABLE_NAME LIKE '%' || #value# || '%' OR
                    DELIMITER LIKE '%' || #value# || '%' OR
                    COLUMNS LIKE '%' || #value# || '%' OR
                    ENCODING LIKE '%' || #value# || '%' OR
                    FILE_EXTENSION LIKE '%' || #value# || '%' OR
                    CAST(CREATED_AT AS VARCHAR(30)) LIKE '%' || #value# || '%' OR
                    CAST(UPDATED_AT AS VARCHAR(30)) LIKE '%' || #value# || '%'
                )
            </isNotEmpty>
        </dynamic>
    </select>

    <insert id="insertFileMeta" parameterClass="fileMeta">
        insert into <include refid="file_meta_table" />
            (INTERFACE_ID, TABLE_NAME, DELIMITER, COLUMNS, ENCODING, HAS_HEADER, FILE_EXTENSION, CREATED_AT)
        values
            (#interfaceId:VARCHAR#, #tableName:VARCHAR#, #delimiter:VARCHAR#, #columns:VARCHAR#, #encoding:VARCHAR#, #hasHeader:SMALLINT#, #fileExtension:VARCHAR#, CURRENT_TIMESTAMP)
    </insert>

    <update id="updateFileMeta" parameterClass="fileMeta">
        update <include refid="file_meta_table" />
        set    TABLE_NAME = #tableName#,
               DELIMITER = #delimiter#,
               COLUMNS = #columns#,
               ENCODING = #encoding#,
               HAS_HEADER = #hasHeader:SMALLINT#,
               FILE_EXTENSION = #fileExtension#,
               UPDATED_AT = CURRENT_TIMESTAMP
        where  INTERFACE_ID = #interfaceId#
    </update>

    <delete id="deleteFileMeta" parameterClass="string">
        delete from <include refid="file_meta_table" />
        where  INTERFACE_ID = #interfaceId#
        AND   TABLE_NAME = #tableName#
    </delete>
    <select id="selectInterfaceList" resultClass="java.util.HashMap">
        SELECT * FROM ATB_INTERFACE ORDER BY INTERFACE_ID
    </select>

    <select id="selectInterfaceCount" resultClass="int">
        SELECT COUNT(*) FROM ATB_INTERFACE
    </select>
</sqlMap>
