<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sqlMap
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="integratedSearch">

	<sql id="product_table">esb_PRODUCT</sql>
	<sql id="imanager_table">esb_IMANAGER</sql>
	<sql id="instance_table">esb_INSTANCE</sql>
	<sql id="instance_file_table">esb_INSTANCE_FILE</sql>
	<sql id="project_table">esb_PROJECT</sql>
	<sql id="indigo_cmm_resource_history_table">INDIGO_CMM_RESOURCE_HISTORY</sql>
	
	<resultMap class="java.util.HashMap" id="search">
		<result property="IN_FILE_NAME" column="in_file_name"/>
		<result property="IN_ID" column="in_id"/>
		<result property="IN_FILE_ID" column="in_file_id"/>
		<result property="IN_FILE_CONTS" column="in_file_conts" typeHandler="declob"/>
		<result property="PD_STATUS" column="pd_status"/>
		<result property="PD_GROUP_ID" column="pd_group_id"/>
		<result property="IN_IM_ID" column="in_im_id"/>
		<result property="PD_NAME" column="pd_name"/>
		<result property="PD_ALIAS" column="pd_alias"/>
		<result property="PJ_NAME" column="pj_name"/>
		<result property="PJ_ID" column="pj_id"/>
		<result property="IM_ALIAS" column="im_alias"/>
		<result property="IM_NAME" column="im_name" />
	</resultMap>
	
	<resultMap id="agent_search" class="java.util.HashMap">
		<result property="PD_TYPE" column="PD_TYPE" />

		<result property="PD_STATUS" column="PD_STATUS" />
		<result property="PD_FIREWALL" column="PD_FIREWALL" />
		<result property="PD_NAME" column="PD_NAME" />
		<result property="IM_VER" column="IM_VER" />
		<result property="IM_IP" column="IM_IP" />
		<result property="IM_PORT" column="IM_PORT" />

		<result property="PD_REG_DATE" column="PD_REG_DATE" javaType="java.util.Date" />

		<result property="PD_ID" column="PD_ID" />
		<result property="PD_NAME" column="PD_NAME" />
		<result property="PD_ALIAS" column="PD_ALIAS" />
		<result property="IN_IM_ID" column="IN_IM_ID" />
		<result property="IM_ID" column="IM_ID" />

	</resultMap>

	<resultMap id="adaptor_search" class="java.util.HashMap">
		<result property="PD_TYPE" column="PD_TYPE" />

		<result property="PD_STATUS" column="PD_STATUS" />
		<result property="IM_ALIAS" column="IM_ALIAS" />
		<result property="PD_ALIAS" column="PD_ALIAS" />
		<result property="IN_DEPLOY_DATE" column="IN_DEPLOY_DATE"
			javaType="java.util.Date" />

		<result property="PD_ID" column="PD_ID" />
		<result property="PD_NAME" column="PD_NAME" />
		<result property="PD_ALIAS" column="PD_ALIAS" />
		<result property="IN_IM_ID" column="IN_IM_ID" />
		<result property="PJ_ID" column="PJ_ID" />
		<result property="PJ_NAME" column="PJ_NAME" />
		<result property="IM_NAME" column="IM_NAME" />
		<result property="IN_ID" column="IN_ID" />
		<result property="PD_REG_DATE" column="PD_REG_DATE" />

	</resultMap>
	

	<select id="agnet_integrated_search" resultMap="agent_search" parameterClass="HashMap">
		SELECT Z.*
    	FROM   (
       		SELECT ROW_NUMBER() OVER() AS ROW_NUM, PD.PD_ID, PD.PD_TYPE, PD.PD_ORDER, PD.PD_NAME, PD.PD_ALIAS, PD.PD_REG_DATE, PD.PD_REG_USER,
	    	    	PD.IN_IM_ID, PD.FINAL_NW_STATUS, PD.FINAL_MO_STATUS, PD.FINAL_MO_REG_DATE, PD.MO_ERROR_CNT,
	    	   	    IM.IM_ID, IM.IM_IP, IM.IM_PORT, IM.IM_OS, IM.IM_INFO, IM.IM_VER, PD.FINAL_DS_STATUS, PD.PD_GROUP_ID,
	    	   	    PD.PD_FAVORITE, PD.PD_FIREWALL, PD.PD_STATUS
        			FROM   (SELECT CASE WHEN {FN TIMESTAMPDIFF(SQL_TSI_SECOND, FINAL_MO_REG_DATE, CURRENT_TIMESTAMP)}  > 180 THEN '-9'
						WHEN {FN TIMESTAMPDIFF(SQL_TSI_SECOND,  FINAL_MO_REG_DATE, CURRENT_TIMESTAMP)} IS NULL THEN 'null'
						ELSE '1' END PD_STATUS, PD1.*
                  			 FROM <include refid="product_table" /> PD1) PD , <include refid="imanager_table" /> IM
        				WHERE  PD.PD_ID = IM.IM_ID
        					<isNotNull property="SEARCH_GROUP" prepend="AND">
								PD.PD_GROUP_ID = #SEARCH_GROUP#
				        	</isNotNull>
        					<isNotNull property="SEARCH_VALUE" prepend="AND">
								(    PD.PD_ALIAS LIKE '%'||#SEARCH_VALUE#||'%'
								  OR PD.PD_NAME LIKE '%'||#SEARCH_VALUE#||'%'
	                              <isNotEqual property="SEARCH_VALUE" compareValue="null"> 
									OR PD.PD_FIREWALL = #SEARCH_VALUE#
									OR PD.PD_STATUS = #SEARCH_VALUE# 
								  </isNotEqual> 
	                              <isEqual property="SEARCH_VALUE" compareValue="null"> 
									OR PD.PD_FIREWALL IS NULL
								  </isEqual> 
								  OR IM.IM_VER LIKE '%'||#SEARCH_VALUE#||'%'
	                              OR IM.IM_IP LIKE '%'||#SEARCH_VALUE#||'%'
	                              OR IM.IM_PORT LIKE '%'||#SEARCH_VALUE#||'%'
					        	)
				        	</isNotNull>
				        	<isNotNull property="SEARCH_AGENT" prepend="AND">
							 ( PD.PD_ALIAS LIKE '%'||#SEARCH_AGENT#||'%'
							OR PD.PD_NAME LIKE '%'||#SEARCH_AGENT#||'%' )
					        </isNotNull>
	                        <isNotNull property="SEARCH_IP" prepend="AND">
							IM.IM_IP LIKE '%'||#SEARCH_IP#||'%'
					        </isNotNull>
	                        <isNotNull property="SEARCH_PORT" prepend="AND">
							IM.IM_PORT LIKE '%'||#SEARCH_PORT#||'%'
					        </isNotNull>
				        	
           				 ORDER BY PD.PD_ORDER, PD.PD_NAME, PD.PD_REG_DATE
           	) Z
    	<![CDATA[
           OFFSET #SKIP_INDEX# ROWS FETCH first #MAX_ROW# ROW ONLY
	]]>
	</select>

	<select id="agnet_integrated_search_total" resultClass="int" parameterClass="HashMap">
       			SELECT COUNT(*)
        			FROM   (SELECT CASE WHEN {FN TIMESTAMPDIFF(SQL_TSI_SECOND, FINAL_MO_REG_DATE, CURRENT_TIMESTAMP)}  > 180 THEN '-9'
						WHEN {FN TIMESTAMPDIFF(SQL_TSI_SECOND,  FINAL_MO_REG_DATE, CURRENT_TIMESTAMP)} IS NULL THEN 'null'
						ELSE '1' END PD_STATUS, PD1.*
                  			 FROM <include refid="product_table" /> PD1) PD , <include refid="imanager_table" /> IM
        				WHERE  PD.PD_ID = IM.IM_ID
        					<isNotNull property="SEARCH_GROUP" prepend="AND">
								PD.PD_GROUP_ID = #SEARCH_GROUP#
				        	</isNotNull>
        					<isNotNull property="SEARCH_VALUE" prepend="AND">
								(    PD.PD_ALIAS LIKE '%'||#SEARCH_VALUE#||'%'
								  OR PD.PD_NAME LIKE '%'||#SEARCH_VALUE#||'%'
	                              <isNotEqual property="SEARCH_VALUE" compareValue="null"> 
									OR PD.PD_FIREWALL = #SEARCH_VALUE#
									OR PD.PD_STATUS = #SEARCH_VALUE# 
								  </isNotEqual> 
	                              <isEqual property="SEARCH_VALUE" compareValue="null"> 
									OR PD.PD_FIREWALL IS NULL
								  </isEqual> 
								  OR IM.IM_VER LIKE '%'||#SEARCH_VALUE#||'%'
	                              OR IM.IM_IP LIKE '%'||#SEARCH_VALUE#||'%'
	                              OR IM.IM_PORT LIKE '%'||#SEARCH_VALUE#||'%'
					        	)
				        	</isNotNull>
				        	<isNotNull property="SEARCH_AGENT" prepend="AND">
							 ( PD.PD_ALIAS LIKE '%'||#SEARCH_AGENT#||'%'
							OR PD.PD_NAME LIKE '%'||#SEARCH_AGENT#||'%' )
					        </isNotNull>
	                        <isNotNull property="SEARCH_IP" prepend="AND">
							IM.IM_IP LIKE '%'||#SEARCH_IP#||'%'
					        </isNotNull>
	                        <isNotNull property="SEARCH_PORT" prepend="AND">
							IM.IM_PORT LIKE '%'||#SEARCH_PORT#||'%'
					        </isNotNull>
	</select>
	
	<select id="adaptor_integrated_search" resultMap="adaptor_search" parameterClass="HashMap">
		SELECT Z.*
    	FROM   (
 			SELECT ROW_NUMBER() OVER() AS ROW_NUM, T.* FROM( SELECT A.PD_ID, A.PD_TYPE, A.PD_NAME, A.PD_ALIAS, A.PD_REG_DATE , A.final_ds_status,
                                           	   A.IN_IM_ID, A.FINAL_NW_STATUS, A.FINAL_MO_STATUS, A.FINAL_MO_REG_DATE, A.MO_ERROR_CNT,
                                               B.PJ_ID, B.IN_DEPLOY_YN, B.IN_DEPLOY_DATE, B.IN_ID, C.PJ_NAME,
                                                ( 
                                               	SELECT B.PD_AlIAS 
                                               	FROM <include refid="product_table" /> B 
                                                WHERE B.PD_ID=A.IN_IM_ID
                                               ) IM_ALIAS,
                                  			   (
                                                SELECT B.PD_NAME 
                                                FROM <include refid="product_table" /> B 
                                                WHERE B.PD_ID=A.IN_IM_ID
                                               ) IM_NAME,
                                               A.PD_STATUS,
                                               C.PJ_GROUP_ID
                                        FROM <include refid="instance_table" /> B, <include refid="project_table"/> C, 
                                                        	(SELECT CASE WHEN {FN TIMESTAMPDIFF(SQL_TSI_SECOND, FINAL_MO_REG_DATE, CURRENT_TIMESTAMP)}  > 180 THEN '-9'
												ELSE CASE WHEN FINAL_MO_STATUS = '-2' THEN '-2'
													WHEN FINAL_MO_STATUS = '-1' THEN '-1'
														ELSE CASE WHEN FINAL_NW_STATUS = '99' THEN '2'
														ELSE CASE WHEN FINAL_MO_STATUS IS NOT NULL THEN FINAL_MO_STATUS
														ELSE 'NULL' END
														END
													END
											 END PD_STATUS, PD1.*
                  							 FROM <include refid="product_table" /> PD1
								                  			ORDER BY PD_ORDER) A
								        WHERE B.IN_ID=A.PD_ID AND B.PJ_ID=C.PJ_ID) T  
							<dynamic prepend="WHERE">								        
	        					<isNotNull property="SEARCH_GROUP" prepend="AND">
									T.PJ_GROUP_ID = #SEARCH_GROUP#
					        	</isNotNull>
	        					<isNotNull property="SEARCH_VALUE" prepend="AND">
									(    T.PD_ALIAS LIKE '%'||#SEARCH_VALUE#||'%'
									  OR T.PD_NAME LIKE '%'||#SEARCH_VALUE#||'%'
	                                  <isNotEqual property="SEARCH_VALUE" compareValue="null"> 
								      	OR T.PD_STATUS = #SEARCH_VALUE# 
									  </isNotEqual> 
		                              <isEqual property="SEARCH_VALUE" compareValue="null">
		                              	OR T.PD_STATUS IS NULL 
		                              </isEqual>
	                                  OR T.IM_ALIAS LIKE '%'||#SEARCH_VALUE#||'%'
                                      OR T.IM_NAME LIKE '%'||#SEARCH_VALUE#||'%'
                                      OR T.PJ_NAME LIKE '%'||#SEARCH_VALUE#||'%'
                                    )
					        	</isNotNull>
									  <isNotNull property="SEARCH_ADAPTOR" prepend="AND">
										  ( T.PD_ALIAS LIKE '%'||#SEARCH_ADAPTOR#||'%'
										 OR T.PD_NAME LIKE '%'||#SEARCH_ADAPTOR#||'%' )
						        	  </isNotNull>
                                	  <isNotNull property="SEARCH_AGENT" prepend="AND">
										  ( T.IM_ALIAS LIKE '%'||#SEARCH_AGENT#||'%'
                                      	 OR T.IM_NAME LIKE '%'||#SEARCH_AGENT#||'%' )
						        	  </isNotNull>
                                	  <isNotNull property="SEARCH_PROJECT" prepend="AND">
										 T.PJ_NAME LIKE '%'||#SEARCH_PROJECT#||'%'
						        	  </isNotNull>
				        	</dynamic>
           	) Z
    	<![CDATA[
           OFFSET #SKIP_INDEX# ROWS FETCH first #MAX_ROW# ROW ONLY
	]]>
	</select>
	
	<select id="adaptor_integrated_search_total" resultClass="int" parameterClass="HashMap">
 			SELECT COUNT(*) FROM( SELECT A.PD_ID, A.PD_TYPE, A.PD_NAME, A.PD_ALIAS, A.PD_REG_DATE , A.final_ds_status,
                                           	   A.IN_IM_ID, A.FINAL_NW_STATUS, A.FINAL_MO_STATUS, A.FINAL_MO_REG_DATE, A.MO_ERROR_CNT,
                                               B.PJ_ID, B.IN_DEPLOY_YN, B.IN_DEPLOY_DATE, B.IN_ID, C.PJ_NAME,
                                                ( 
                                               	SELECT B.PD_AlIAS 
                                               	FROM <include refid="product_table" /> B 
                                                WHERE B.PD_ID=A.IN_IM_ID
                                               ) IM_ALIAS,
                                  			   (
                                                SELECT B.PD_NAME 
                                                FROM <include refid="product_table" /> B 
                                                WHERE B.PD_ID=A.IN_IM_ID
                                               ) IM_NAME,
                                               A.PD_STATUS,
                                               C.PJ_GROUP_ID
                                        FROM <include refid="instance_table"/> B, <include refid="project_table"/> C, 
                                                        	(SELECT CASE WHEN {FN TIMESTAMPDIFF(SQL_TSI_SECOND, FINAL_MO_REG_DATE, CURRENT_TIMESTAMP)}  > 180 THEN '-9'
													ELSE CASE WHEN FINAL_MO_STATUS = '-2' THEN '-2'
														WHEN FINAL_MO_STATUS = '-1' THEN '-1'
														ELSE CASE WHEN FINAL_NW_STATUS = '99' THEN '2'
														ELSE CASE WHEN FINAL_MO_STATUS IS NOT NULL THEN FINAL_MO_STATUS
														ELSE 'NULL' END
															END
														END
												 END PD_STATUS, PD1.*
                  								 FROM <include refid="product_table" /> PD1
								                  			 ORDER BY PD_ORDER) A
								        WHERE B.IN_ID=A.PD_ID AND B.PJ_ID=C.PJ_ID) T  
							<dynamic prepend="WHERE">								        
	        					<isNotNull property="SEARCH_GROUP" prepend="AND">
									T.PJ_GROUP_ID = #SEARCH_GROUP#
					        	</isNotNull>
	        					<isNotNull property="SEARCH_VALUE" prepend="AND">
									(    T.PD_ALIAS LIKE '%'||#SEARCH_VALUE#||'%'
									  OR T.PD_NAME LIKE '%'||#SEARCH_VALUE#||'%'
	                                  <isNotEqual property="SEARCH_VALUE" compareValue="null"> 
								      	OR T.PD_STATUS = #SEARCH_VALUE# 
									  </isNotEqual> 
		                              <isEqual property="SEARCH_VALUE" compareValue="null">
		                              	OR T.PD_STATUS IS NULL 
		                              </isEqual>
	                                  OR T.IM_ALIAS LIKE '%'||#SEARCH_VALUE#||'%'
                                      OR T.IM_NAME LIKE '%'||#SEARCH_VALUE#||'%'
                                      OR T.PJ_NAME LIKE '%'||#SEARCH_VALUE#||'%'
                                    )
					        	</isNotNull>
									  <isNotNull property="SEARCH_ADAPTOR" prepend="AND">
										  ( T.PD_ALIAS LIKE '%'||#SEARCH_ADAPTOR#||'%'
										 OR T.PD_NAME LIKE '%'||#SEARCH_ADAPTOR#||'%' )
						        	  </isNotNull>
                                	  <isNotNull property="SEARCH_AGENT" prepend="AND">
										  ( T.IM_ALIAS LIKE '%'||#SEARCH_AGENT#||'%'
                                      	 OR T.IM_NAME LIKE '%'||#SEARCH_AGENT#||'%' )
						        	  </isNotNull>
                                	  <isNotNull property="SEARCH_PROJECT" prepend="AND">
										 T.PJ_NAME LIKE '%'||#SEARCH_PROJECT#||'%'
						        	  </isNotNull>
				        	</dynamic>
	</select>
	
	<select id="integrated-search-adaptor-profile" resultMap="search" parameterClass="HashMap">
		SELECT Z.*
    	FROM   (
			SELECT ROW_NUMBER() OVER() AS ROW_NUM, T.*
				FROM(SELECT A.IN_FILE_NAME, A.IN_ID, A.IN_FILE_ID , H.HISTORY_FILE_CONTS  AS IN_FILE_CONTS, PD_STATUS, B.PD_GROUP_ID, B.IN_IM_ID, B.PD_NAME, B.PD_ALIAS, D.PJ_NAME, D.PJ_ID,
						( SELECT F.PD_ALIAS  FROM esb_PRODUCT F  WHERE F.PD_ID = B.IN_IM_ID ) IM_ALIAS,
					   ( SELECT F.PD_NAME  	FROM esb_PRODUCT F  WHERE F.PD_ID = B.IN_IM_ID ) IM_NAME 
						FROM <include refid="instance_file_table"/> A, (SELECT CASE WHEN {FN TIMESTAMPDIFF(SQL_TSI_SECOND, FINAL_MO_REG_DATE, CURRENT_TIMESTAMP)}  > 180 THEN '-9'
													ELSE CASE WHEN FINAL_MO_STATUS = '-2' THEN '-2'
														WHEN FINAL_MO_STATUS = '-1' THEN '-1'
														ELSE CASE WHEN FINAL_NW_STATUS = '99' THEN '2'
														ELSE CASE WHEN FINAL_MO_STATUS IS NOT NULL THEN FINAL_MO_STATUS
														ELSE 'NULL' END
															END
														END
												 END PD_STATUS, PD1.*
                  								 FROM <include refid="product_table" /> PD1 ORDER BY PD_ORDER) B, 
							 <include refid="instance_table"/> C, <include refid="project_table"/> D, <include refid="indigo_cmm_resource_history_table"/> H
								WHERE B.PD_ID = A.IN_ID AND A.IN_ID=C.IN_ID AND C.PJ_ID = D.PJ_ID AND A.HISTORY_ID = H.HISTORY_ID AND H.USE_DATAYN = 'Y' AND B.PD_TYPE='AD'
									<isNotNull property="SEARCH_VALUE" prepend="AND">
										H.HISTORY_FILE_CONTS LIKE '%'||#SEARCH_VALUE#||'%'
											 <!-- <isNotEqual property="SEARCH_VALUE" compareValue="null">
										      utl_raw.cast_to_raw (CONVERT(#SEARCH_VALUE:BLOB#, 'AL32UTF8', 'KO16MSWIN949'))
											  </isNotEqual>
				                              <isEqual property="SEARCH_VALUE" compareValue="null">
				                              NULL 
				                              </isEqual>
										, 1, 1) > 0 -->
									</isNotNull>
									<isNotNull property="SEARCH_ADAPTOR" prepend="AND">
											 ( B.PD_ALIAS LIKE '%'||#SEARCH_ADAPTOR#||'%'
											OR B.PD_NAME LIKE '%'||#SEARCH_ADAPTOR#||'%' )
								    </isNotNull>
									) T
									<dynamic prepend="WHERE">	
										<isNotNull property="SEARCH_GROUP" prepend="AND">
											T.PD_GROUP_ID = #SEARCH_GROUP#
										</isNotNull>
									</dynamic>
           	) Z
    	<![CDATA[
           OFFSET #SKIP_INDEX# ROWS FETCH first #MAX_ROW# ROW ONLY
	]]>
	</select>	
	
	<select id="integrated-search-adaptor-profile_total" resultClass="int" parameterClass="HashMap">
	SELECT COUNT(*)
		FROM(SELECT A.IN_FILE_NAME, A.IN_ID, A.IN_FILE_ID , H.HISTORY_FILE_CONTS AS IN_FILE_CONTS, PD_STATUS, B.PD_GROUP_ID, B.IN_IM_ID, B.PD_NAME, B.PD_ALIAS, D.PJ_NAME, D.PJ_ID
				FROM <include refid="instance_file_table"/> A, (SELECT CASE WHEN {FN TIMESTAMPDIFF(SQL_TSI_SECOND, FINAL_MO_REG_DATE, CURRENT_TIMESTAMP)}  > 180 THEN '-9'
													ELSE CASE WHEN FINAL_MO_STATUS = '-2' THEN '-2'
														WHEN FINAL_MO_STATUS = '-1' THEN '-1'
														ELSE CASE WHEN FINAL_NW_STATUS = '99' THEN '2'
														ELSE CASE WHEN FINAL_MO_STATUS IS NOT NULL THEN FINAL_MO_STATUS
														ELSE 'NULL' END
															END
														END
												 END PD_STATUS, PD1.*
                  								 FROM <include refid="product_table" /> PD1 ORDER BY PD_ORDER) B, 
					 <include refid="instance_table"/> C, <include refid="project_table"/> D, <include refid="indigo_cmm_resource_history_table"/> H
						WHERE B.PD_ID = A.IN_ID AND A.IN_ID=C.IN_ID AND C.PJ_ID = D.PJ_ID AND A.HISTORY_ID = H.HISTORY_ID AND H.USE_DATAYN = 'Y' AND B.PD_TYPE='AD'
							<isNotNull property="SEARCH_VALUE" prepend="AND">
									H.HISTORY_FILE_CONTS LIKE '%'||#SEARCH_VALUE#||'%'
								<!-- DBMS_LOB.INSTR (H.HISTORY_FILE_CONTS, 
									  <isNotEqual property="SEARCH_VALUE" compareValue="null">
								    utl_raw.cast_to_raw (CONVERT(#SEARCH_VALUE#, 'AL32UTF8', 'KO16MSWIN949'))
									  </isNotEqual> 
		                              <isEqual property="SEARCH_VALUE" compareValue="null">
		                              NULL 
		                              </isEqual>
								, 1, 1) > 0 -->
							</isNotNull>
							<isNotNull property="SEARCH_ADAPTOR" prepend="AND">
									 ( B.PD_ALIAS LIKE '%'||#SEARCH_ADAPTOR#||'%'
									OR B.PD_NAME LIKE '%'||#SEARCH_ADAPTOR#||'%' )
						    </isNotNull>
							) T
							<dynamic prepend="WHERE">	
								<isNotNull property="SEARCH_GROUP" prepend="AND">
									T.PD_GROUP_ID = #SEARCH_GROUP#
								</isNotNull>
							</dynamic>
	</select>
</sqlMap>