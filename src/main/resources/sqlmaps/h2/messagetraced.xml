<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="message_traced">
	<typeAlias alias="messagetraced" type="com.indigo.web.visualization.modeler.vo.IndigoModelerMessageTracedVo"/>
	
		<select id="getMessageTracedList" resultClass="messagetraced" parameterClass="java.util.HashMap">
	SELECT T2.*
	FROM(SELECT ROWNUM ROW_NUM, T1.*, nvl(EXTRACT(MINUTE FROM LTIME) * 60 + EXTRACT(SECOND FROM LTIME),-1) AS  LEADTIME
		 FROM(SELECT * FROM
		(SELECT GROUPEXCHANGEID , ROUTEID AS STARTROUTEID
				, (SELECT COUNT(*) FROM INDIGO_MESSAGETRACED SUB WHERE TRACETABLE.GROUPEXCHANGEID = SUB.GROUPEXCHANGEID AND INOUT = 'IN') AS PROCESSCOUNT
				, TO_CHAR(MIN(TIMESTAMP),'YYYY-MM-DD HH24:MI:SS') AS STARTTIME 
				, TO_CHAR(MAX(TIMESTAMP),'YYYY-MM-DD HH24:MI:SS') AS ENDTIME
				,(TO_TIMESTAMP(TO_CHAR(MAX(TIMESTAMP),'YYYY-MM-DD HH24:MI:SS.FF3'),'RR/MM/DD HH24:MI:SS.FF') -  TO_TIMESTAMP(TO_CHAR(MIN(TIMESTAMP),'YYYY-MM-DD HH24:MI:SS.FF3'),'RR/MM/DD HH24:MI:SS.FF'))AS LTIME
				, CASE WHEN SUM(DECODE(STATUS, 'D', 1, 0)) > 0 THEN 'D'
 				WHEN SUM(DECODE(STATUS, 'E', 1, 0)) > 0 THEN 'E'
  				ELSE 'P'
  				END AS STATUS 
		FROM INDIGO_MESSAGETRACED TRACETABLE
		<dynamic prepend="where">
			<isNotNull prepend="AND" property="STA_DATE">
				TIMESTAMP BETWEEN TO_TIMESTAMP(#STA_DATE#,'RR/MM/DD HH24:MI:SS.FF') AND  TO_TIMESTAMP(#END_DATE#,'RR/MM/DD HH24:MI:SS.FF')
			</isNotNull>
			<isNotNull prepend="AND" property="GROUPEXCHANGEID">
				(TX_ID LIKE '%$TX_ID$%' OR ROUTEID LIKE '%$GROUPEXCHANGEID$%')
			</isNotNull>
		</dynamic>
		GROUP BY GROUPEXCHANGEID, ROUTEID
		ORDER BY STARTTIME DESC)
		<dynamic prepend="where">
			<isNotNull prepend="AND" property="STATUS">
				STATUS = #STATUS#
			</isNotNull>
		</dynamic>)T1 
		)T2
		<![CDATA[
			WHERE  ROW_NUM > #PAGE_INDEX#
			AND  ROW_NUM <= #PAGE_INDEX# + #MAX_ROW#
		]]>
	</select>
	
	<select id="getMessageTracedListSize" resultClass="int" parameterClass="java.util.HashMap">
	SELECT COUNT(*) FROM
		(SELECT GROUPEXCHANGEID , ROUTEID AS STARTROUTEID
				, (SELECT COUNT(*) FROM INDIGO_MESSAGETRACED SUB WHERE TRACETABLE.GROUPEXCHANGEID = SUB.GROUPEXCHANGEID AND INOUT = 'IN') AS PROCESSCOUNT
				, TO_CHAR(MIN(TIMESTAMP),'YYYY-MM-DD HH24:MI:SS') AS STARTTIME 
				, TO_CHAR(MAX(TIMESTAMP),'YYYY-MM-DD HH24:MI:SS') AS ENDTIME
				, CASE WHEN SUM(DECODE(STATUS, 'D', 1, 0)) > 0 THEN 'D'
 				WHEN SUM(DECODE(STATUS, 'E', 1, 0)) > 0 THEN 'E'
  				ELSE 'P'
  				END AS STATUS 
		FROM INDIGO_MESSAGETRACED TRACETABLE
		<dynamic prepend="where">
			<isNotNull prepend="AND" property="STA_DATE">
				TIMESTAMP BETWEEN TO_TIMESTAMP(#STA_DATE#,'RR/MM/DD HH24:MI:SS.FF') AND  TO_TIMESTAMP(#END_DATE#,'RR/MM/DD HH24:MI:SS.FF')
			</isNotNull>
			<isNotNull prepend="AND" property="GROUPEXCHANGEID">
				TX_ID like '%$TX_ID$%'
			</isNotNull>
		</dynamic>
		GROUP BY GROUPEXCHANGEID, ROUTEID
		ORDER BY GROUPEXCHANGEID)
		<dynamic prepend="where">
			<isNotNull prepend="AND" property="STATUS">
				STATUS = #STATUS#
			</isNotNull>
		</dynamic>
	</select>
	
<!-- 	<select id="getMessageTracedDetailList" resultClass="messagetraced" parameterClass="string">
		SELECT MSGLT.* , nvl(EXTRACT(MINUTE FROM LTIME) * 60 + EXTRACT(SECOND FROM LTIME),-1) AS  LEADTIME 
 		FROM (SELECT TO_CHAR(TRACETABLE.TIMESTAMP,'YYYY-MM-DD HH24:MI:SS') AS STARTTIME,   
					(SELECT TO_CHAR(T.TIMESTAMP,'YYYY-MM-DD HH24:MI:SS') FROM INDIGO_MESSAGETRACED T WHERE EXCHANGEID = TRACETABLE.EXCHANGEID AND NODEID      = TRACETABLE.NODEID AND INOUT = 'OUT') AS ENDTIME,  
					TO_TIMESTAMP(TO_CHAR((SELECT T.TIMESTAMP FROM INDIGO_MESSAGETRACED T WHERE EXCHANGEID = TRACETABLE.EXCHANGEID AND NODEID      = TRACETABLE.NODEID AND INOUT = 'OUT'),'YYYY-MM-DD HH24:MI:SS.FF3'),'RR/MM/DD HH24:MI:SS.FF') - TO_TIMESTAMP(TO_CHAR(TRACETABLE.TIMESTAMP,'YYYY-MM-DD HH24:MI:SS.FF3'),'RR/MM/DD HH24:MI:SS.FF') AS LTIME, 
 					NODEID, ID, PROPERTIES, TIMESTAMP, HEADERS, EXCHANGEID, BODY, EXCHANGEPATTERN, ROUTEID, FROMENDPOINTURI, PREVIOUSNODE, TONODE, SHORTEXCHANGEID, BODYTYPE, OUTBODY, OUTBODYTYPE,
 					OUTHEADERS, CAUSEDBYEXCEPTION, INOUT, GROUPEXCHANGEID, (SELECT T.STATUS FROM INDIGO_MESSAGETRACED T WHERE EXCHANGEID = TRACETABLE.EXCHANGEID AND NODEID      = TRACETABLE.NODEID AND INOUT = 'OUT') AS STATUS
 			FROM INDIGO_MESSAGETRACED TRACETABLE    WHERE TX_ID = #value# AND INOUT='IN'
 		)MSGLT
		ORDER BY MSGLT.ID 			 
	</select> -->
	
	<select id="getMessageTracedDetailList" resultClass="messagetraced" parameterClass="string">
		SELECT MSGLT.*
 		FROM (SELECT TRACETABLE.TIME_STAMP AS STARTTIME
	 			, (SELECT T.TIME_STAMP FROM INDIGO_MESSAGETRACED T WHERE EXCHANGEID = TRACETABLE.EXCHANGEID AND NODEID = TRACETABLE.NODEID AND IN_OUT = 'OUT') AS ENDTIME
	 			, NODEID
	 			, ID
	 			, PROPERTIES
	 			, TIME_STAMP
	 			, HEADERS
	 			, EXCHANGEID, BODY
	 			, EXCHANGEPATTERN
	 			, ROUTEID
	 			, FROMENDPOINTURI
	 			, PREVIOUSNODE
	 			, TONODE
	 			, SHORTEXCHANGEID
	 			, BODYTYPE
	 			, OUTBODY
	 			, OUTBODYTYPE
	 			, OUTHEADERS
	 			, CAUSEDBYEXCEPTION
	 			, IN_OUT AS 'INOUT'
	 			, GROUPEXCHANGEID
	 			, (SELECT T.STATUS FROM INDIGO_MESSAGETRACED T WHERE EXCHANGEID = TRACETABLE.EXCHANGEID AND NODEID = TRACETABLE.NODEID AND IN_OUT = 'OUT') AS STATUS
	 			FROM INDIGO_MESSAGETRACED TRACETABLE 
	 			WHERE TX_ID = #value#
	 			AND IN_OUT='IN'
 		)MSGLT
		ORDER BY MSGLT.ID
	</select>

	
	<select id="getMessageTracedStatus" resultClass="String" parameterClass="String">
		SELECT T.STATUS FROM INDIGO_MESSAGETRACED T  	WHERE  TX_ID = #value# and STATUS = 'E' GROUP BY T.STATUS
	</select>
	
	<select id="getMessageTracedStatusProc" resultClass="String" parameterClass="String">
		SELECT ZZ.STATUS FROM(
		SELECT ROW_NUMBER() OVER () AS ROW_NUM, Z.*
		FROM(
		SELECT 
		CASE WHEN (SELECT COUNT(TX_ID) FROM INDIGO_MESSAGETRACED WHERE  TX_ID = #value#) = (SELECT COUNT(TX_ID) FROM INDIGO_MESSAGETRACED WHERE  TX_ID = #value# AND STATUS='P') THEN 'N'
			ELSE NULL
		END AS STATUS
	  	FROM INDIGO_MESSAGETRACED T
	  	WHERE  TX_ID = #value#) Z) ZZ
	  	WHERE ROW_NUM=1
	</select>
	
	<select id="getInOutDetailData" resultClass="messagetraced" parameterClass="java.util.HashMap">
	SELECT ID ,PROPERTIES ,TIME_STAMP AS TIMESTAMP
			,HEADERS ,EXCHANGEID ,BODY ,EXCHANGEPATTERN ,ROUTEID ,FROMENDPOINTURI
			,PREVIOUSNODE ,TONODE ,SHORTEXCHANGEID, BODYTYPE, OUTBODY, OUTBODYTYPE
			,OUTHEADERS, CAUSEDBYEXCEPTION, IN_OUT AS 'INOUT', GROUPEXCHANGEID, STATUS
	FROM INDIGO_MESSAGETRACED
		<dynamic prepend="where">
			<isNotEmpty prepend="AND" property="groupexchangeid">
				GROUPEXCHANGEID = #groupexchangeid#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="tonode"> 
				TONODE = #tonode#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="exchangeid">
				EXCHANGEID = #exchangeid#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="id">
				ID = #id#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="nodeid">
				NODEID = #nodeid#
			</isNotEmpty>
		</dynamic>
		 ORDER BY IN_OUT ASC		 
	</select>
	
	<select id="getPropertyData" resultClass="messagetraced" parameterClass="java.util.HashMap">
	SELECT HEADERS FROM INDIGO_MESSAGETRACED
		<dynamic prepend="where">
			<isNotEmpty prepend="AND" property="groupexchangeid">
				GROUPEXCHANGEID = #groupexchangeid#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="tonode"> 
				TONODE = #tonode#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="exchangeid">
				EXCHANGEID = #exchangeid#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="id">
				ID = #id#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="nodeid">
				NODEID = #nodeid#
			</isNotEmpty>
		</dynamic>
		 ORDER BY "INOUT" ASC		 
	</select>
	
	<select id="getMessageData" resultClass="messagetraced" parameterClass="java.util.HashMap">
	SELECT BODY,OUTBODY,CAUSEDBYEXCEPTION,"INOUT" FROM INDIGO_MESSAGETRACED
		<dynamic prepend="where">
			<isNotEmpty prepend="AND" property="groupexchangeid">
				GROUPEXCHANGEID = #groupexchangeid#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="tonode"> 
				TONODE = #tonode#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="exchangeid">
				EXCHANGEID = #exchangeid#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="id">
				ID = #id#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="nodeid">
				NODEID = #nodeid#
			</isNotEmpty>
		</dynamic>
		 ORDER BY "INOUT" ASC		 
	</select>
	
	<select id="getMessageTracedStatistic" resultClass="messagetraced" parameterClass="java.util.HashMap">
	SELECT DAYS, SUM(A.PCNT) AS PCNT, SUM(A.DCNT) AS DCNT, SUM(A.ECNT) AS ECNT
	FROM (SELECT  GROUPEXCHANGEID, ROUTEID, SUBSTR(CAST(TIMESTAMP AS VARCHAR(30)), $STR_IDX$ , $END_IDX$ ) AS DAYS,
	CASE WHEN ( SUM(CASE WHEN STATUS = 'D' THEN 1 ELSE 0 END)) > 0 THEN 1 ELSE 0 END  AS DCNT,
	CASE WHEN ( SUM(CASE WHEN STATUS = 'E' THEN 1 ELSE 0 END)) > 0 THEN 1 ELSE 0 END  AS ECNT, 
	CASE WHEN (CASE WHEN SUM(CASE WHEN STATUS = 'D' THEN 1 ELSE 0 END)  > 0 THEN 'D' WHEN SUM(CASE WHEN STATUS = 'E' THEN 1 ELSE 0 END) > 0 THEN 'E'       ELSE 'P' END) = 'P'  THEN 1 ELSE 0 END AS PCNT
	FROM INDIGO_MESSAGETRACED 
	<dynamic prepend="where">
		<isNotNull prepend="AND" property="STA_DATE">  
		TIMESTAMP BETWEEN #STA_DATE# AND #END_DATE#
		</isNotNull>
		<isNotEmpty prepend="AND" property="SERVICE_NAME">
		ROUTEID=#SERVICE_NAME#
		</isNotEmpty>
		<!-- <isNotNull prepend="AND" property="SERVICE_NAME">  
		ROUTEID=#SERVICE_NAME#
		</isNotNull> -->
	</dynamic>   
	GROUP BY GROUPEXCHANGEID, ROUTEID, SUBSTR(CAST(TIMESTAMP AS VARCHAR(30)), $STR_IDX$ , $END_IDX$ )) A
	GROUP BY DAYS
	</select>
	
	<select id="getRouteIdList" resultClass="String">
	SELECT ROUTEID FROM INDIGO_MESSAGETRACED
	GROUP BY ROUTEID
	ORDER BY ROUTEID
	</select>
</sqlMap>